<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>区块管理模块设计文档 | NULS</title>
    <meta name="description" content="NULS">
    <link rel="icon" href="/icon.png">
    
    <link rel="preload" href="/assets/css/0.styles.3751d6d5.css" as="style"><link rel="preload" href="/assets/js/app.0877bdcb.js" as="script"><link rel="preload" href="/assets/js/25.0460bbcd.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc8f5c2.js"><link rel="prefetch" href="/assets/js/100.d3a152d6.js"><link rel="prefetch" href="/assets/js/101.2a081cb7.js"><link rel="prefetch" href="/assets/js/102.a47ba456.js"><link rel="prefetch" href="/assets/js/103.d5ac9751.js"><link rel="prefetch" href="/assets/js/104.7595a7fc.js"><link rel="prefetch" href="/assets/js/105.828dda8f.js"><link rel="prefetch" href="/assets/js/106.e754f194.js"><link rel="prefetch" href="/assets/js/107.775c5175.js"><link rel="prefetch" href="/assets/js/108.8b1f0e7f.js"><link rel="prefetch" href="/assets/js/109.2f3b3253.js"><link rel="prefetch" href="/assets/js/11.b0ceb74e.js"><link rel="prefetch" href="/assets/js/110.aa04c678.js"><link rel="prefetch" href="/assets/js/111.f62d78bb.js"><link rel="prefetch" href="/assets/js/112.69acd927.js"><link rel="prefetch" href="/assets/js/113.888160f3.js"><link rel="prefetch" href="/assets/js/114.29e41199.js"><link rel="prefetch" href="/assets/js/115.d2ee5369.js"><link rel="prefetch" href="/assets/js/116.51fc87d4.js"><link rel="prefetch" href="/assets/js/117.4c9dc648.js"><link rel="prefetch" href="/assets/js/118.83070636.js"><link rel="prefetch" href="/assets/js/119.665c7995.js"><link rel="prefetch" href="/assets/js/12.02dfbd69.js"><link rel="prefetch" href="/assets/js/120.214bbe7a.js"><link rel="prefetch" href="/assets/js/121.bf9971ed.js"><link rel="prefetch" href="/assets/js/122.7560b52a.js"><link rel="prefetch" href="/assets/js/123.1d267c1f.js"><link rel="prefetch" href="/assets/js/124.f5bbb448.js"><link rel="prefetch" href="/assets/js/125.376b8644.js"><link rel="prefetch" href="/assets/js/126.f44dfff9.js"><link rel="prefetch" href="/assets/js/127.4bfabc7b.js"><link rel="prefetch" href="/assets/js/128.f1386192.js"><link rel="prefetch" href="/assets/js/129.bc8e43b2.js"><link rel="prefetch" href="/assets/js/13.6ff2f0d4.js"><link rel="prefetch" href="/assets/js/130.cacc4ae3.js"><link rel="prefetch" href="/assets/js/131.84d456ba.js"><link rel="prefetch" href="/assets/js/132.2aae8ca6.js"><link rel="prefetch" href="/assets/js/133.1a312ad1.js"><link rel="prefetch" href="/assets/js/134.703ce965.js"><link rel="prefetch" href="/assets/js/135.8cee3887.js"><link rel="prefetch" href="/assets/js/136.b36f5811.js"><link rel="prefetch" href="/assets/js/137.eda59c8e.js"><link rel="prefetch" href="/assets/js/138.551346e5.js"><link rel="prefetch" href="/assets/js/139.3a3f1471.js"><link rel="prefetch" href="/assets/js/14.fa820f23.js"><link rel="prefetch" href="/assets/js/140.1e504789.js"><link rel="prefetch" href="/assets/js/141.4bf908a3.js"><link rel="prefetch" href="/assets/js/142.618b966f.js"><link rel="prefetch" href="/assets/js/143.36491f90.js"><link rel="prefetch" href="/assets/js/144.76d9a156.js"><link rel="prefetch" href="/assets/js/145.be4615d5.js"><link rel="prefetch" href="/assets/js/146.a073f6bd.js"><link rel="prefetch" href="/assets/js/147.fec28542.js"><link rel="prefetch" href="/assets/js/148.1a4b00b2.js"><link rel="prefetch" href="/assets/js/149.6671cebe.js"><link rel="prefetch" href="/assets/js/15.1f656e2a.js"><link rel="prefetch" href="/assets/js/150.75db4652.js"><link rel="prefetch" href="/assets/js/151.b3ee235e.js"><link rel="prefetch" href="/assets/js/152.63fb9894.js"><link rel="prefetch" href="/assets/js/153.852b7cff.js"><link rel="prefetch" href="/assets/js/154.dbd3a07d.js"><link rel="prefetch" href="/assets/js/155.6f6f946b.js"><link rel="prefetch" href="/assets/js/156.8e16b0e8.js"><link rel="prefetch" href="/assets/js/157.8dbfeb43.js"><link rel="prefetch" href="/assets/js/158.919c857b.js"><link rel="prefetch" href="/assets/js/159.09925f42.js"><link rel="prefetch" href="/assets/js/16.aa19419e.js"><link rel="prefetch" href="/assets/js/160.797785d9.js"><link rel="prefetch" href="/assets/js/161.4d34eb09.js"><link rel="prefetch" href="/assets/js/162.94099c67.js"><link rel="prefetch" href="/assets/js/163.9f984d63.js"><link rel="prefetch" href="/assets/js/164.9e26163d.js"><link rel="prefetch" href="/assets/js/165.c8de855f.js"><link rel="prefetch" href="/assets/js/166.d8e0213d.js"><link rel="prefetch" href="/assets/js/167.778d1b2a.js"><link rel="prefetch" href="/assets/js/168.6ad455d7.js"><link rel="prefetch" href="/assets/js/169.f26a480a.js"><link rel="prefetch" href="/assets/js/17.4eef6f4e.js"><link rel="prefetch" href="/assets/js/170.9f0e1298.js"><link rel="prefetch" href="/assets/js/171.fc4a1cfb.js"><link rel="prefetch" href="/assets/js/172.d5c28bec.js"><link rel="prefetch" href="/assets/js/173.2cfc6896.js"><link rel="prefetch" href="/assets/js/174.6ac11f1d.js"><link rel="prefetch" href="/assets/js/175.ff16c02e.js"><link rel="prefetch" href="/assets/js/176.5d7156d4.js"><link rel="prefetch" href="/assets/js/177.89dacd78.js"><link rel="prefetch" href="/assets/js/178.a59d32eb.js"><link rel="prefetch" href="/assets/js/179.a6c468fe.js"><link rel="prefetch" href="/assets/js/18.f6c2f0b8.js"><link rel="prefetch" href="/assets/js/180.ebd647d5.js"><link rel="prefetch" href="/assets/js/181.872ce38a.js"><link rel="prefetch" href="/assets/js/182.0db6d70c.js"><link rel="prefetch" href="/assets/js/183.963128a1.js"><link rel="prefetch" href="/assets/js/184.b537b1fa.js"><link rel="prefetch" href="/assets/js/185.30696c6b.js"><link rel="prefetch" href="/assets/js/186.0ad2973d.js"><link rel="prefetch" href="/assets/js/187.ada551ca.js"><link rel="prefetch" href="/assets/js/188.0bf963be.js"><link rel="prefetch" href="/assets/js/189.39991fc7.js"><link rel="prefetch" href="/assets/js/19.c066ca9d.js"><link rel="prefetch" href="/assets/js/190.7453b0ea.js"><link rel="prefetch" href="/assets/js/191.6f8d2b48.js"><link rel="prefetch" href="/assets/js/192.ffa7a0ae.js"><link rel="prefetch" href="/assets/js/193.6b5187de.js"><link rel="prefetch" href="/assets/js/194.33c85b12.js"><link rel="prefetch" href="/assets/js/195.6ce6baa9.js"><link rel="prefetch" href="/assets/js/196.b7f7795d.js"><link rel="prefetch" href="/assets/js/197.56c70085.js"><link rel="prefetch" href="/assets/js/198.2b4a23bb.js"><link rel="prefetch" href="/assets/js/199.07618bd4.js"><link rel="prefetch" href="/assets/js/2.434158f1.js"><link rel="prefetch" href="/assets/js/20.5171c565.js"><link rel="prefetch" href="/assets/js/200.cd38ef32.js"><link rel="prefetch" href="/assets/js/201.63a35536.js"><link rel="prefetch" href="/assets/js/202.8463e76c.js"><link rel="prefetch" href="/assets/js/203.c2eff4d8.js"><link rel="prefetch" href="/assets/js/204.1b6a7ee2.js"><link rel="prefetch" href="/assets/js/205.84d64836.js"><link rel="prefetch" href="/assets/js/21.db5c56e6.js"><link rel="prefetch" href="/assets/js/22.498863f8.js"><link rel="prefetch" href="/assets/js/23.9f1f092a.js"><link rel="prefetch" href="/assets/js/24.2dd53084.js"><link rel="prefetch" href="/assets/js/26.cac7fce9.js"><link rel="prefetch" href="/assets/js/27.d07d1fcb.js"><link rel="prefetch" href="/assets/js/28.af448362.js"><link rel="prefetch" href="/assets/js/29.014f7be8.js"><link rel="prefetch" href="/assets/js/3.944c2fb9.js"><link rel="prefetch" href="/assets/js/30.71024fdc.js"><link rel="prefetch" href="/assets/js/31.a1d400ee.js"><link rel="prefetch" href="/assets/js/32.f6916684.js"><link rel="prefetch" href="/assets/js/33.7a11d236.js"><link rel="prefetch" href="/assets/js/34.2e902b60.js"><link rel="prefetch" href="/assets/js/35.77cbe800.js"><link rel="prefetch" href="/assets/js/36.b4a03b7d.js"><link rel="prefetch" href="/assets/js/37.835e1993.js"><link rel="prefetch" href="/assets/js/38.d905a078.js"><link rel="prefetch" href="/assets/js/39.9a0ea84a.js"><link rel="prefetch" href="/assets/js/4.10b50b1a.js"><link rel="prefetch" href="/assets/js/40.6894dc38.js"><link rel="prefetch" href="/assets/js/41.9abdd72f.js"><link rel="prefetch" href="/assets/js/42.791cbfec.js"><link rel="prefetch" href="/assets/js/43.b4204359.js"><link rel="prefetch" href="/assets/js/44.79523177.js"><link rel="prefetch" href="/assets/js/45.52dab45f.js"><link rel="prefetch" href="/assets/js/46.d45f0044.js"><link rel="prefetch" href="/assets/js/47.66798c19.js"><link rel="prefetch" href="/assets/js/48.2f7186f9.js"><link rel="prefetch" href="/assets/js/49.5efe22f1.js"><link rel="prefetch" href="/assets/js/5.54beffe8.js"><link rel="prefetch" href="/assets/js/50.76124638.js"><link rel="prefetch" href="/assets/js/51.b430df64.js"><link rel="prefetch" href="/assets/js/52.dc55c14c.js"><link rel="prefetch" href="/assets/js/53.32933bde.js"><link rel="prefetch" href="/assets/js/54.5f4ba8e6.js"><link rel="prefetch" href="/assets/js/55.07cb4238.js"><link rel="prefetch" href="/assets/js/56.051d4b4e.js"><link rel="prefetch" href="/assets/js/57.bd3f6e79.js"><link rel="prefetch" href="/assets/js/58.220ce9c8.js"><link rel="prefetch" href="/assets/js/59.896c6030.js"><link rel="prefetch" href="/assets/js/6.0c2e36a1.js"><link rel="prefetch" href="/assets/js/60.936ac7e3.js"><link rel="prefetch" href="/assets/js/61.f607b3ec.js"><link rel="prefetch" href="/assets/js/62.a2eb63e8.js"><link rel="prefetch" href="/assets/js/63.42f2c68e.js"><link rel="prefetch" href="/assets/js/64.ab1a2432.js"><link rel="prefetch" href="/assets/js/65.23af0670.js"><link rel="prefetch" href="/assets/js/66.2cf2b73c.js"><link rel="prefetch" href="/assets/js/67.dd039849.js"><link rel="prefetch" href="/assets/js/68.c1f2396d.js"><link rel="prefetch" href="/assets/js/69.f64d6dc5.js"><link rel="prefetch" href="/assets/js/7.66c6371d.js"><link rel="prefetch" href="/assets/js/70.1b8f30ff.js"><link rel="prefetch" href="/assets/js/71.6abde1ee.js"><link rel="prefetch" href="/assets/js/72.a80f16f5.js"><link rel="prefetch" href="/assets/js/73.6690fcbd.js"><link rel="prefetch" href="/assets/js/74.d7f82bfd.js"><link rel="prefetch" href="/assets/js/75.fc906157.js"><link rel="prefetch" href="/assets/js/76.106a4524.js"><link rel="prefetch" href="/assets/js/77.ad77edec.js"><link rel="prefetch" href="/assets/js/78.10c7b197.js"><link rel="prefetch" href="/assets/js/79.08097c6d.js"><link rel="prefetch" href="/assets/js/8.b37e7034.js"><link rel="prefetch" href="/assets/js/80.c33bd3c0.js"><link rel="prefetch" href="/assets/js/81.c1c8227b.js"><link rel="prefetch" href="/assets/js/82.042ca332.js"><link rel="prefetch" href="/assets/js/83.371427a4.js"><link rel="prefetch" href="/assets/js/84.95658ce6.js"><link rel="prefetch" href="/assets/js/85.e4365ba5.js"><link rel="prefetch" href="/assets/js/86.c5ed5194.js"><link rel="prefetch" href="/assets/js/87.1a56019a.js"><link rel="prefetch" href="/assets/js/88.a0664933.js"><link rel="prefetch" href="/assets/js/89.365bb774.js"><link rel="prefetch" href="/assets/js/9.c34e88ed.js"><link rel="prefetch" href="/assets/js/90.2330af89.js"><link rel="prefetch" href="/assets/js/91.25be9d8a.js"><link rel="prefetch" href="/assets/js/92.7fca59f6.js"><link rel="prefetch" href="/assets/js/93.5d25de24.js"><link rel="prefetch" href="/assets/js/94.52f3f774.js"><link rel="prefetch" href="/assets/js/95.3da9bca5.js"><link rel="prefetch" href="/assets/js/96.24b73c87.js"><link rel="prefetch" href="/assets/js/97.cd2d42fb.js"><link rel="prefetch" href="/assets/js/98.a520e926.js"><link rel="prefetch" href="/assets/js/99.22c2d988.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3751d6d5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">NULS</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/learn/" class="nav-link">了解NULS</a></div><div class="nav-item"><a href="/zh/NULS1.0/" class="nav-link">NULS1.0</a></div><div class="nav-item"><a href="/zh/NULS2.0/" class="nav-link">NULS2.0</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NULSInfrastructure/blockModuleDesign.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/NULSInfrastructure/blockModuleDesign.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/nuls-io/devsite" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/learn/" class="nav-link">了解NULS</a></div><div class="nav-item"><a href="/zh/NULS1.0/" class="nav-link">NULS1.0</a></div><div class="nav-item"><a href="/zh/NULS2.0/" class="nav-link">NULS2.0</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NULSInfrastructure/blockModuleDesign.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/NULSInfrastructure/blockModuleDesign.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/nuls-io/devsite" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </div> <div class="page"> <div class="content"><h1 id="区块管理模块设计文档"><a href="#区块管理模块设计文档" aria-hidden="true" class="header-anchor">#</a> 区块管理模块设计文档</h1> <p>[TOC]</p> <h2 id="一、总体描述"><a href="#一、总体描述" aria-hidden="true" class="header-anchor">#</a> 一、总体描述</h2> <h3 id="_1-1-模块概述"><a href="#_1-1-模块概述" aria-hidden="true" class="header-anchor">#</a> 1.1 模块概述</h3> <h4 id="_1-1-1-为什么要有《区块管理》模块"><a href="#_1-1-1-为什么要有《区块管理》模块" aria-hidden="true" class="header-anchor">#</a> 1.1.1 为什么要有《区块管理》模块</h4> <p>​	区块链上所有交易数据都保存在区块中，所以要有一个模块负责区块的存储与管理，以便其他模块对区块中数据进行验证、业务处理时可以获取到区块。</p> <p>​	区块链程序初次启动时，需要同步网络上的最新区块到本地，这个过程一般耗时较长，且同步未完成时不能发起交易，所以适合由单独模块来完成该工作。</p> <p>​	综上所述，为其他模块提供统一的区块数据服务是必要的，也能更好地把区块的管理与区块的具体业务进行分离，用到区块的模块不必关心区块的获取细节。</p> <h4 id="_1-1-2-《区块管理》要做什么"><a href="#_1-1-2-《区块管理》要做什么" aria-hidden="true" class="header-anchor">#</a> 1.1.2 《区块管理》要做什么</h4> <p>​	系统启动时，判断本地区块高度是否达到网络上大多数节点的最新高度，如果没有达到，要从网络上下载区块到本地，进行区块的验证，验证通过后，保存到本地数据库，这叫区块的同步。</p> <p>​	区块同步完成后，系统开始正常运行，分下面两种情况讨论</p> <ul><li>如果是自身节点打包区块，共识模块会把打包好的区块交给区块管理模块，区块管理模块会负责进行区块验证、区块保存、区块广播，并且要响应网络上的其他节点发起的获取该区块的请求。</li> <li>如果是其他共识节点打包区块，本地节点会收到网络上发来的转发区块消息，此时要从其他节点获取区块信息，进行验证并保存，保存完成后再次转发该区块，让区块在全网传播。</li></ul> <p>异常情况下，区块验证不通过，新区块无法与主链上最后一个区块相连，则把该区块视为分叉区块或孤儿区块，放入分叉链集合维护。当发现有一条分叉链A比主链B高度更高时，进行链切换，以分叉链A为最新的链
，原主链B回滚，并进入分叉链集合维护。</p> <pre><code>对外提供区块头、区块查询服务
</code></pre> <h4 id="_1-1-3-《区块管理》在系统中的定位"><a href="#_1-1-3-《区块管理》在系统中的定位" aria-hidden="true" class="header-anchor">#</a> 1.1.3 《区块管理》在系统中的定位</h4> <p>区块管理是底层模块之一，以下分功能讨论模块依赖情况</p> <p>依赖</p> <ul><li>区块同步-依赖网络模块的通讯接口，依赖工具模块的序列化工具</li> <li>区块存储、回滚-依赖工具模块的数据库存储工具、共识模块、交易管理模块</li> <li>区块转发-依赖网络模块的广播消息接口</li></ul> <p>被依赖</p> <ul><li>整个系统可以发起交易-区块同步</li> <li>共识模块:区块详细验证、打包-区块查询、区块保存、区块广播、区块回滚</li></ul> <h3 id="_1-2-架构图"><a href="#_1-2-架构图" aria-hidden="true" class="header-anchor">#</a> 1.2 架构图</h3> <p><img src="/assets/img/block-module.ffc57f74.png" alt></p> <h2 id="二、功能设计"><a href="#二、功能设计" aria-hidden="true" class="header-anchor">#</a> 二、功能设计</h2> <h3 id="_2-1-功能架构图"><a href="#_2-1-功能架构图" aria-hidden="true" class="header-anchor">#</a> 2.1 功能架构图</h3> <p><img src="image/block-module/block-functions.png" alt></p> <ol><li>提供api，进行区块存储、查询、回滚的操作</li> <li>从网络上同步最新区块，进行初步验证、分叉验证，如果没有分叉，调用共识模块进行共识验证，调用交易模块进行交易验证，全部验证通过后保存到本地。</li> <li>区块同步、广播、转发消息的处理</li> <li>分叉区块的判断、存储</li> <li>孤儿区块的判断、存储</li> <li>分叉链维护、切换</li> <li>孤儿链维护、切换</li></ol> <h3 id="_2-2-模块服务"><a href="#_2-2-模块服务" aria-hidden="true" class="header-anchor">#</a> 2.2 模块服务</h3> <h4 id="_2-2-1-获取本地最新区块头"><a href="#_2-2-1-获取本地最新区块头" aria-hidden="true" class="header-anchor">#</a> 2.2.1 获取本地最新区块头</h4> <ul><li>接口说明</li></ul> <ol><li>根据链ID、缓存的最新区块高度查询DB得到最新区块头HASH</li> <li>根据HASH查询DB得到区块头byte数组</li> <li>反序列化为区块头对象</li></ol> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bestBlockHeader&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {
        &quot;chainId&quot;: &quot;888&quot;,
        &quot;hash&quot;: &quot;xxxxxxx&quot;,
        &quot;preHash&quot;: &quot;xxxxxxx&quot;,
        &quot;merkleHash&quot;: &quot;1&quot;,
        &quot;height&quot;: 1,
        &quot;size&quot;: 1,
        &quot;time&quot;: 1,
        &quot;txCount&quot;: 1,
        &quot;packingAddress&quot;: &quot;1&quot;,
        &quot;reward&quot;: 0,
        &quot;fee&quot;: 0,
        &quot;extend&quot;: xxxxxxx,HEX
        &quot;scriptSig&quot;: &quot;1&quot;
    }
}
</code></pre></div></li> <li><p>返回字段说明</p></li></ul> <table><thead><tr><th>parameter</th> <th>type</th> <th>description</th></tr></thead> <tbody><tr><td>chainId</td> <td>Long</td> <td>链ID</td></tr> <tr><td>hash</td> <td>String</td> <td>区块HASH</td></tr> <tr><td>preHash</td> <td>String</td> <td>上一区块HASH</td></tr> <tr><td>merkleHash</td> <td>String</td> <td>区块MerkleHash</td></tr> <tr><td>height</td> <td>Long</td> <td>区块高度</td></tr> <tr><td>size</td> <td>Integer</td> <td>区块大小</td></tr> <tr><td>time</td> <td>Long</td> <td>区块打包时间</td></tr> <tr><td>txCount</td> <td>Integer</td> <td>交易数</td></tr> <tr><td>packingAddress</td> <td>String</td> <td>打包地址</td></tr> <tr><td>reward</td> <td>Long</td> <td>共识奖励</td></tr> <tr><td>fee</td> <td>Long</td> <td>手续费</td></tr> <tr><td>extend</td> <td>String</td> <td>扩展字段,HEX,包含roundIndex、roundStartTime、consensusMemberCount、packingIndexOfRound、stateRoot</td></tr> <tr><td>scriptSig</td> <td>String</td> <td>区块签名</td></tr></tbody></table> <h4 id="_2-2-2-获取本地最新区块"><a href="#_2-2-2-获取本地最新区块" aria-hidden="true" class="header-anchor">#</a> 2.2.2 获取本地最新区块</h4> <ul><li>接口说明:</li></ul> <ol><li>根据链ID获取本地最新区块头</li> <li>根据区块头高度查询DB得到交易HASH列表</li> <li>根据HASH列表从交易管理模块获取交易数据</li> <li>组装成block对象</li></ol> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bestBlock&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <pre><code>```
{
    &quot;version&quot;: 1.2,
    &quot;code&quot;:1,
    &quot;msg&quot; :&quot;xxxxxxxxxxxxxxxxxx&quot;,
    &quot;result&quot;:{}
}
```
</code></pre> <p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {
    	&quot;blockHeader&quot;: {
            &quot;chainId&quot;: &quot;888&quot;,
            &quot;hash&quot;: &quot;xxxxxxx&quot;,
            &quot;preHash&quot;: &quot;xxxxxxx&quot;,
            &quot;merkleHash&quot;: &quot;1&quot;,
            &quot;height&quot;: 1,
            &quot;size&quot;: 1,
            &quot;time&quot;: 1,
            &quot;txCount&quot;: 1,
            &quot;packingAddress&quot;: &quot;1&quot;,
            &quot;reward&quot;: 0,
            &quot;fee&quot;: 0,
            &quot;extend&quot;: xxxxxxx,HEX
            &quot;scriptSig&quot;: &quot;1&quot;
    	}, //区块头
    	&quot;transactions&quot;: [
    	    {
                &quot;chainId&quot;: &quot;888&quot;, //链Id
                &quot;height&quot;: &quot;1&quot;, //区块高度
                &quot;hash&quot;: &quot;1&quot;, //交易HASH
                &quot;remark&quot;: &quot;1&quot;, //交易备注
                &quot;size&quot;: &quot;1&quot;, //交易大小
                &quot;time&quot;: &quot;1&quot;, //交易时间
                &quot;type&quot;: &quot;1&quot;, //交易类型
                &quot;transactionSignature&quot;: &quot;1&quot;, //交易签名
                &quot;coinData&quot;: {
                    &quot;from&quot; : [
                        {
                            &quot;fromAssetsChainId&quot;:&quot;&quot;//资产发行链的id  
                            &quot;fromAssetsId&quot;:&quot;&quot;//资产id
                            &quot;fromAddress&quot;:&quot;&quot;//转出账户地址
                            &quot;amount&quot;:&quot;&quot;//转出金额
                            &quot;nonce&quot;:&quot;&quot;//交易顺序号，递增
                        },{...}
                    ]
                    &quot;to&quot; : [
                        {
                            &quot;toAssetsChainId&quot;:&quot;&quot;//资产发行链的id  
                            &quot;toAssetsId&quot;:&quot;&quot;//资产id
                            &quot;toAddress&quot;:&quot;&quot;//转出账户地址
                            &quot;amount&quot;:&quot;&quot;//转出金额
                            &quot;locktime&quot;:&quot;&quot;
                        },{...}
                    ]
                }
                &quot;txData&quot;: XXXX, //交易数据 HEX
    	    },
    	    {...}
    	] //交易列表
    }
}
</code></pre></div></li> <li><p>返回字段说明</p> <p>略</p></li></ul> <h4 id="_2-2-3-根据高度获取区块头"><a href="#_2-2-3-根据高度获取区块头" aria-hidden="true" class="header-anchor">#</a> 2.2.3 根据高度获取区块头</h4> <ul><li>接口说明</li></ul> <ol><li>根据链ID、高度查询DB得到最新区块头HASH</li> <li>根据HASH查询DB得到区块头byte数组</li> <li>反序列化为区块头对象</li></ol> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;getBlockHeaderByHeight&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;111&quot;,&quot;888&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr> <tr><td>1</td> <td>height</td> <td>true</td> <td>Long</td> <td style="text-align:center">区块高度</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {
        &quot;chainId&quot;: &quot;888&quot;,
        &quot;hash&quot;: &quot;xxxxxxx&quot;,
        &quot;preHash&quot;: &quot;xxxxxxx&quot;,
        &quot;merkleHash&quot;: &quot;1&quot;,
        &quot;height&quot;: 1,
        &quot;size&quot;: 1,
        &quot;time&quot;: 1,
        &quot;txCount&quot;: 1,
        &quot;packingAddress&quot;: &quot;1&quot;,
        &quot;reward&quot;: 0,
        &quot;fee&quot;: 0,
        &quot;extend&quot;: xxxxxxx,HEX
        &quot;scriptSig&quot;: &quot;1&quot;
    }
}
</code></pre></div></li> <li><p>返回字段说明</p></li></ul> <table><thead><tr><th>parameter</th> <th>type</th> <th>description</th></tr></thead> <tbody><tr><td>chainId</td> <td>Long</td> <td>链Id</td></tr> <tr><td>hash</td> <td>String</td> <td>区块HASH</td></tr> <tr><td>preHash</td> <td>String</td> <td>上一区块HASH</td></tr> <tr><td>merkleHash</td> <td>String</td> <td>区块MerkleHash</td></tr> <tr><td>height</td> <td>Long</td> <td>区块高度</td></tr> <tr><td>size</td> <td>Integer</td> <td>区块大小</td></tr> <tr><td>time</td> <td>Long</td> <td>区块打包时间</td></tr> <tr><td>txCount</td> <td>Integer</td> <td>交易数</td></tr> <tr><td>packingAddress</td> <td>String</td> <td>打包地址</td></tr> <tr><td>reward</td> <td>Long</td> <td>共识奖励</td></tr> <tr><td>fee</td> <td>Long</td> <td>手续费</td></tr> <tr><td>extend</td> <td>String</td> <td>扩展字段,HEX,包含roundIndex、roundStartTime、consensusMemberCount、packingIndexOfRound、stateRoot</td></tr> <tr><td>scriptSig</td> <td>String</td> <td>区块签名</td></tr></tbody></table> <h4 id="_2-2-4-根据高度获取区块"><a href="#_2-2-4-根据高度获取区块" aria-hidden="true" class="header-anchor">#</a> 2.2.4 根据高度获取区块</h4> <ul><li>接口说明:</li></ul> <ol><li>根据链ID、高度获取区块头</li> <li>根据区块头高度查询DB得到交易HASH列表</li> <li>根据HASH列表从交易管理模块获取交易数据</li> <li>组装成block对象</li></ol> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bl_getBlockByHeight&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;111&quot;,&quot;888&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr> <tr><td>1</td> <td>height</td> <td>true</td> <td>Long</td> <td style="text-align:center">区块高度</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <pre><code>```
{
    &quot;version&quot;: 1.2,
    &quot;code&quot;:1,
    &quot;msg&quot; :&quot;xxxxxxxxxxxxxxxxxx&quot;,
    &quot;result&quot;:{}
}
```
</code></pre> <p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {
    	&quot;blockHeader&quot;: {
            &quot;chainId&quot;: &quot;888&quot;,
            &quot;hash&quot;: &quot;xxxxxxx&quot;,
            &quot;preHash&quot;: &quot;xxxxxxx&quot;,
            &quot;merkleHash&quot;: &quot;1&quot;,
            &quot;height&quot;: 1,
            &quot;size&quot;: 1,
            &quot;time&quot;: 1,
            &quot;txCount&quot;: 1,
            &quot;packingAddress&quot;: &quot;1&quot;,
            &quot;reward&quot;: 0,
            &quot;fee&quot;: 0,
            &quot;extend&quot;: xxxxxxx,HEX
            &quot;scriptSig&quot;: &quot;1&quot;
    	}, //区块头
    	&quot;transactions&quot;: [
    	    {
                &quot;chainId&quot;: &quot;888&quot;,//链ID
                &quot;height&quot;: &quot;1&quot;, //区块高度
                &quot;hash&quot;: &quot;1&quot;, //交易HASH
                &quot;remark&quot;: &quot;1&quot;, //交易备注
                &quot;size&quot;: &quot;1&quot;, //交易大小
                &quot;time&quot;: &quot;1&quot;, //交易时间
                &quot;type&quot;: &quot;1&quot;, //交易类型
                &quot;transactionSignature&quot;: &quot;1&quot;, //交易签名
                &quot;coinData&quot;: {
                    &quot;from&quot; : [
                        {
                            &quot;fromAssetsChainId&quot;:&quot;&quot;//资产发行链的id  
                            &quot;fromAssetsId&quot;:&quot;&quot;//资产id
                            &quot;fromAddress&quot;:&quot;&quot;//转出账户地址
                            &quot;amount&quot;:&quot;&quot;//转出金额
                            &quot;nonce&quot;:&quot;&quot;//交易顺序号，递增
                        },{...}
                    ]
                    &quot;to&quot; : [
                        {
                            &quot;toAssetsChainId&quot;:&quot;&quot;//资产发行链的id  
                            &quot;toAssetsId&quot;:&quot;&quot;//资产id
                            &quot;toAddress&quot;:&quot;&quot;//转出账户地址
                            &quot;amount&quot;:&quot;&quot;//转出金额
                            &quot;nonce&quot;:&quot;&quot;//交易顺序号，递增
                        },{...}
                    ]
                }
                &quot;txData&quot;: XXXX, //交易数据 HEX
    	    },
    	    {...}
    	], //交易列表
    }
}
</code></pre></div></li> <li><p>返回字段说明</p> <p>略</p></li></ul> <h4 id="_2-2-5-根据hash获取区块头"><a href="#_2-2-5-根据hash获取区块头" aria-hidden="true" class="header-anchor">#</a> 2.2.5 根据HASH获取区块头</h4> <ul><li>接口说明</li></ul> <ol><li>根据链ID、HASH查询DB得到区块头byte数组</li> <li>反序列化为区块头对象</li></ol> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bl_getBlockHeaderByHash&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;,&quot;aaa&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr> <tr><td>1</td> <td>hash</td> <td>true</td> <td>String</td> <td style="text-align:center">区块hash</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {
        &quot;chainId&quot;: &quot;888&quot;,
        &quot;hash&quot;: &quot;xxxxxxx&quot;,
        &quot;preHash&quot;: &quot;xxxxxxx&quot;,
        &quot;merkleHash&quot;: &quot;1&quot;,
        &quot;height&quot;: 1,
        &quot;size&quot;: 1,
        &quot;time&quot;: 1,
        &quot;txCount&quot;: 1,
        &quot;packingAddress&quot;: &quot;1&quot;,
        &quot;reward&quot;: 0,
        &quot;fee&quot;: 0,
        &quot;extend&quot;: xxxxxxx,HEX
        &quot;scriptSig&quot;: &quot;1&quot;
    }
}
</code></pre></div></li> <li><p>返回字段说明</p></li></ul> <table><thead><tr><th>parameter</th> <th>type</th> <th>description</th></tr></thead> <tbody><tr><td>chainId</td> <td>Long</td> <td>链ID</td></tr> <tr><td>hash</td> <td>String</td> <td>区块HASH</td></tr> <tr><td>preHash</td> <td>String</td> <td>上一区块HASH</td></tr> <tr><td>merkleHash</td> <td>String</td> <td>区块MerkleHash</td></tr> <tr><td>height</td> <td>Long</td> <td>区块高度</td></tr> <tr><td>size</td> <td>Integer</td> <td>区块大小</td></tr> <tr><td>time</td> <td>Long</td> <td>区块打包时间</td></tr> <tr><td>txCount</td> <td>Integer</td> <td>交易数</td></tr> <tr><td>packingAddress</td> <td>String</td> <td>打包地址</td></tr> <tr><td>reward</td> <td>Long</td> <td>共识奖励</td></tr> <tr><td>fee</td> <td>Long</td> <td>手续费</td></tr> <tr><td>extend</td> <td>String</td> <td>扩展字段,HEX,包含roundIndex、roundStartTime、consensusMemberCount、packingIndexOfRound、stateRoot</td></tr> <tr><td>scriptSig</td> <td>String</td> <td>区块签名</td></tr></tbody></table> <h4 id="_2-2-6-根据hash获取区块"><a href="#_2-2-6-根据hash获取区块" aria-hidden="true" class="header-anchor">#</a> 2.2.6 根据HASH获取区块</h4> <ul><li>接口说明:</li></ul> <ol><li>根据链ID、hash获取区块头</li> <li>根据区块头高度查询DB得到交易HASH列表</li> <li>根据HASH列表从交易管理模块获取交易数据</li> <li>组装成block对象</li></ol> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bl_getBlockByHash&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;,&quot;aaa&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr> <tr><td>1</td> <td>hash</td> <td>true</td> <td>String</td> <td style="text-align:center">区块hash</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <pre><code>```
{
    &quot;version&quot;: 1.2,
    &quot;code&quot;:1,
    &quot;msg&quot; :&quot;xxxxxxxxxxxxxxxxxx&quot;,
    &quot;result&quot;:{}
}
```
</code></pre> <p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {
    	&quot;blockHeader&quot;: {
    	    &quot;chainId&quot;: &quot;888&quot;,
            &quot;hash&quot;: &quot;xxxxxxx&quot;,
            &quot;preHash&quot;: &quot;xxxxxxx&quot;,
            &quot;merkleHash&quot;: &quot;1&quot;,
            &quot;height&quot;: 1,
            &quot;size&quot;: 1,
            &quot;time&quot;: 1,
            &quot;txCount&quot;: 1,
            &quot;packingAddress&quot;: &quot;1&quot;,
            &quot;reward&quot;: 0,
            &quot;fee&quot;: 0,
            &quot;extend&quot;: xxxxxxx,HEX
            &quot;scriptSig&quot;: &quot;1&quot;
    	}, //区块头
    	&quot;transactions&quot;: [
    	    {
    	        &quot;chainId&quot;: &quot;888&quot;,
                &quot;height&quot;: &quot;1&quot;, //区块高度
                &quot;hash&quot;: &quot;1&quot;, //交易HASH
                &quot;remark&quot;: &quot;1&quot;, //交易备注
                &quot;size&quot;: &quot;1&quot;, //交易大小
                &quot;time&quot;: &quot;1&quot;, //交易时间
                &quot;type&quot;: &quot;1&quot;, //交易类型
                &quot;transactionSignature&quot;: &quot;1&quot;, //交易签名
                &quot;coinData&quot;: {
                    &quot;from&quot; : [
                        {
                            &quot;fromAssetsChainId&quot;:&quot;&quot;//资产发行链的id  
                            &quot;fromAssetsId&quot;:&quot;&quot;//资产id
                            &quot;fromAddress&quot;:&quot;&quot;//转出账户地址
                            &quot;amount&quot;:&quot;&quot;//转出金额
                            &quot;nonce&quot;:&quot;&quot;//交易顺序号，递增
                        },{...}
                    ]
                    &quot;to&quot; : [
                        {
                            &quot;toAssetsChainId&quot;:&quot;&quot;//资产发行链的id  
                            &quot;toAssetsId&quot;:&quot;&quot;//资产id
                            &quot;toAddress&quot;:&quot;&quot;//转出账户地址
                            &quot;amount&quot;:&quot;&quot;//转出金额
                            &quot;nonce&quot;:&quot;&quot;//交易顺序号，递增
                        },{...}
                    ]
                }
                &quot;txData&quot;: XXXX, //交易数据 HEX
    	    },
    	    {...}
    	], //交易列表
    }
}
</code></pre></div></li> <li><p>返回字段说明</p> <p>略</p></li></ul> <h4 id="_2-2-7-获取当前同步区块状态"><a href="#_2-2-7-获取当前同步区块状态" aria-hidden="true" class="header-anchor">#</a> 2.2.7 获取当前同步区块状态</h4> <ul><li>接口说明</li></ul> <p>某个ChainID上的区块同步完成时，更新缓存的同步状态标识。同步区块未完成时，禁止发起交易</p> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bl_getSynchronizeInfo&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {&quot;chainId&quot;: &quot;888&quot;, &quot;sync&quot;: &quot;true&quot;}
}
</code></pre></div></li> <li><p>返回字段说明</p></li></ul> <table><thead><tr><th>parameter</th> <th>type</th> <th>description</th></tr></thead> <tbody><tr><td>chainId</td> <td>String</td> <td>链ID</td></tr> <tr><td>sync</td> <td>String</td> <td>区块同步是否完成</td></tr></tbody></table> <h4 id="_2-2-8-获取某高度区间内区块头"><a href="#_2-2-8-获取某高度区间内区块头" aria-hidden="true" class="header-anchor">#</a> 2.2.8 获取某高度区间内区块头</h4> <ul><li>接口说明</li></ul> <ol><li>令queryHash=endHash</li> <li>根据链ID、queryHash查询DB得到区块头byte数组</li> <li>反序列化为区块头对象blockHeader，添加到List中作为返回值</li> <li>如果blockHeader.hash!=startHash，令queryHash=blockHeader.preHash，重复第2步</li> <li>返回List</li></ol> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bl_getBlockHeaderBetweenHeights&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;,111&quot;,&quot;111&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr> <tr><td>1</td> <td>startHeight</td> <td>true</td> <td>Long</td> <td style="text-align:center">起始高度</td></tr> <tr><td>2</td> <td>endHeight</td> <td>true</td> <td>Long</td> <td style="text-align:center">结束高度</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {
        &quot;list&quot; : [
            {
           &quot;chainId&quot;: &quot;888&quot;,
           &quot;hash&quot;: &quot;xxxxxxx&quot;,
           &quot;preHash&quot;: &quot;xxxxxxx&quot;,
           &quot;merkleHash&quot;: &quot;1&quot;,
           &quot;height&quot;: 1,
           &quot;size&quot;: 1,
           &quot;time&quot;: 1,
           &quot;txCount&quot;: 1,
           &quot;packingAddress&quot;: &quot;1&quot;,
           &quot;reward&quot;: 0,
           &quot;fee&quot;: 0,
           &quot;extend&quot;: xxxxxxx,HEX
           &quot;scriptSig&quot;: &quot;1&quot;
           }
        ]

    }
}
</code></pre></div></li> <li><p>返回字段说明</p></li></ul> <table><thead><tr><th>parameter</th> <th>type</th> <th>description</th></tr></thead> <tbody><tr><td>chainId</td> <td>Long</td> <td>链ID</td></tr> <tr><td>hash</td> <td>String</td> <td>区块HASH</td></tr> <tr><td>preHash</td> <td>String</td> <td>上一区块HASH</td></tr> <tr><td>merkleHash</td> <td>String</td> <td>区块MerkleHash</td></tr> <tr><td>height</td> <td>Long</td> <td>区块高度</td></tr> <tr><td>size</td> <td>Integer</td> <td>区块大小</td></tr> <tr><td>time</td> <td>Long</td> <td>区块打包时间</td></tr> <tr><td>txCount</td> <td>Integer</td> <td>交易数</td></tr> <tr><td>packingAddress</td> <td>String</td> <td>打包地址</td></tr> <tr><td>reward</td> <td>Long</td> <td>共识奖励</td></tr> <tr><td>fee</td> <td>Long</td> <td>手续费</td></tr> <tr><td>extend</td> <td>String</td> <td>扩展字段,HEX,包含roundIndex、roundStartTime、consensusMemberCount、packingIndexOfRound、stateRoot</td></tr> <tr><td>scriptSig</td> <td>String</td> <td>区块签名</td></tr></tbody></table> <h4 id="_2-2-9-获取某高度区间内区块"><a href="#_2-2-9-获取某高度区间内区块" aria-hidden="true" class="header-anchor">#</a> 2.2.9 获取某高度区间内区块</h4> <ul><li>接口说明</li></ul> <ol><li>令queryHash=endHash</li> <li>根据链ID、queryHash查询DB得到区块byte数组</li> <li>反序列化为区块对象block，添加到List中作为返回值</li> <li>如果block.hash!=startHash，令queryHash=block.preHash，startHash，重复第2步</li> <li>返回List</li></ol> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bl_getBlockBetweenHeights&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;,111&quot;,&quot;111&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p></li></ul> <table><thead><tr><th>index</th> <th>parameter</th> <th>required</th> <th>type</th> <th style="text-align:center">description</th></tr></thead> <tbody><tr><td>0</td> <td>chainId</td> <td>true</td> <td>Long</td> <td style="text-align:center">链ID</td></tr> <tr><td>1</td> <td>startHeight</td> <td>true</td> <td>Long</td> <td style="text-align:center">起始高度</td></tr> <tr><td>2</td> <td>endHeight</td> <td>true</td> <td>Long</td> <td style="text-align:center">结束高度</td></tr></tbody></table> <ul><li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {
        &quot;list&quot; : [
            {
                &quot;blockHeader&quot;: {
                    &quot;chainId&quot;: &quot;888&quot;,
                    &quot;hash&quot;: &quot;xxxxxxx&quot;,
                    &quot;preHash&quot;: &quot;xxxxxxx&quot;,
                    &quot;merkleHash&quot;: &quot;1&quot;,
                    &quot;height&quot;: 1,
                    &quot;size&quot;: 1,
                    &quot;time&quot;: 1,
                    &quot;txCount&quot;: 1,
                    &quot;packingAddress&quot;: &quot;1&quot;,
                    &quot;reward&quot;: 0,
                    &quot;fee&quot;: 0,
                    &quot;extend&quot;: xxxxxxx,HEX
                    &quot;scriptSig&quot;: &quot;1&quot;
                }, //区块头
                &quot;transactions&quot;: [
                    {
                        &quot;chainId&quot;: &quot;888&quot;,
                        &quot;height&quot;: &quot;1&quot;, //区块高度
                        &quot;hash&quot;: &quot;1&quot;, //交易HASH
                        &quot;remark&quot;: &quot;1&quot;, //交易备注
                        &quot;size&quot;: &quot;1&quot;, //交易大小
                        &quot;time&quot;: &quot;1&quot;, //交易时间
                        &quot;type&quot;: &quot;1&quot;, //交易类型
                        &quot;transactionSignature&quot;: &quot;1&quot;, //交易签名
                        &quot;coinData&quot;: {
                            &quot;from&quot; : [
                                {
                                    &quot;fromAssetsChainId&quot;:&quot;&quot;//资产发行链的id  
                                    &quot;fromAssetsId&quot;:&quot;&quot;//资产id
                                    &quot;fromAddress&quot;:&quot;&quot;//转出账户地址
                                    &quot;amount&quot;:&quot;&quot;//转出金额
                                    &quot;nonce&quot;:&quot;&quot;//交易顺序号，递增
                                },{...}
                            ]
                            &quot;to&quot; : [
                                {
                                    &quot;toAssetsChainId&quot;:&quot;&quot;//资产发行链的id  
                                    &quot;toAssetsId&quot;:&quot;&quot;//资产id
                                    &quot;toAddress&quot;:&quot;&quot;//转出账户地址
                                    &quot;amount&quot;:&quot;&quot;//转出金额
                                    &quot;nonce&quot;:&quot;&quot;//交易顺序号，递增
                                },{...}
                            ]
                        }
                        &quot;txData&quot;: XXXX, //交易数据 HEX
                    },
                    {...}
                ], //交易列表
           }
        ]

    }
}
</code></pre></div></li> <li><p>返回字段说明</p> <p>略</p></li></ul> <h4 id="_2-2-10-接收最新打包区块"><a href="#_2-2-10-接收最新打包区块" aria-hidden="true" class="header-anchor">#</a> 2.2.10 接收最新打包区块</h4> <ul><li>接口说明</li></ul> <p>本地节点共识模块打包后，调用此接口保存区块数据</p> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;receivePackingBlock&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [
  	blockhex//能用hex就用hex
  ]
}
</code></pre></div></li> <li><p>请求参数说明</p> <p>略</p></li> <li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {&quot;sync&quot;: &quot;true&quot;}
}
</code></pre></div></li> <li><p>返回字段说明</p></li></ul> <table><thead><tr><th>parameter</th> <th>type</th> <th>description</th></tr></thead> <tbody><tr><td>sync</td> <td>String</td> <td>区块是否保存成功</td></tr></tbody></table> <h4 id="_2-2-11-运行一条链"><a href="#_2-2-11-运行一条链" aria-hidden="true" class="header-anchor">#</a> 2.2.11 运行一条链</h4> <ul><li>接口说明</li></ul> <p>在链工厂发布一条链后，核心模块会调用区块管理模块的该接口，根据chainID初始化区块、分叉链数据库，开启chainID对应的一系列工作线程，并为运行新链做准备。</p> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bl_startChain&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p> <p>略</p></li> <li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {&quot;result&quot;: &quot;true&quot;}
}
</code></pre></div></li> <li><p>返回字段说明</p></li></ul> <table><thead><tr><th>parameter</th> <th>type</th> <th>description</th></tr></thead> <tbody><tr><td>result</td> <td>String</td> <td>新链是否启动成功</td></tr></tbody></table> <h4 id="_2-2-12-停止一条链"><a href="#_2-2-12-停止一条链" aria-hidden="true" class="header-anchor">#</a> 2.2.12 停止一条链</h4> <ul><li>接口说明</li></ul> <p>在链工厂停止一条链后，核心模块会调用区块管理模块的该接口，删除该链的缓存区块、分叉链数据，停止chainID对应的一系列工作线程。</p> <ul><li><p>请求示例</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;cmd&quot;: &quot;bl_stopChain&quot;,
  &quot;minVersion&quot;:&quot;1.1&quot;,
  &quot;params&quot;: [&quot;888&quot;]
}
</code></pre></div></li> <li><p>请求参数说明</p> <p>略</p></li> <li><p>返回示例</p> <p>Failed</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 1,
    &quot;msg&quot;: &quot;error message&quot;,
    &quot;result&quot;: {}
}
</code></pre></div><p>Success</p> <div class="language- extra-class"><pre class="language-text"><code>{
    &quot;version&quot;: 1.2,
    &quot;code&quot;: 0,
    &quot;result&quot;: {&quot;result&quot;: &quot;true&quot;}
}
</code></pre></div></li> <li><p>返回字段说明</p></li></ul> <table><thead><tr><th>parameter</th> <th>type</th> <th>description</th></tr></thead> <tbody><tr><td>result</td> <td>String</td> <td>新链是否停止成功</td></tr></tbody></table> <h3 id="_2-3-模块内部功能"><a href="#_2-3-模块内部功能" aria-hidden="true" class="header-anchor">#</a> 2.3 模块内部功能</h3> <h4 id="_2-3-1-模块启动"><a href="#_2-3-1-模块启动" aria-hidden="true" class="header-anchor">#</a> 2.3.1 模块启动</h4> <ul><li><p>功能说明:</p> <p>略</p></li> <li><p>流程描述</p></li></ul> <p><img src="/assets/img/block-module-boot.4686b7bf.png" alt></p> <ul><li>1.加载区块模块配置信息</li> <li>2.加载区块模块消息、消息处理器</li> <li>3.注册区块模块服务接口（向核心模块注册）</li> <li>4.注册区块模块事件（向事件总线模块注册）</li> <li>5.启动同步区块线程、区块监控线程、分叉链处理线程</li></ul> <ul><li><p>依赖服务</p> <p>工具模块、内核模块</p></li></ul> <h4 id="_2-3-2-区块存储"><a href="#_2-3-2-区块存储" aria-hidden="true" class="header-anchor">#</a> 2.3.2 区块存储</h4> <ul><li><p>功能说明:</p> <p>说明存储表划分</p> <ul><li>主链存储</li></ul> <div class="language- extra-class"><pre class="language-text"><code>     不同的链存到不同的表，表名加chainID后缀
     一个完整的区块由区块头和交易组成，区块头与交易分别进行存储。
       区块头:(放在区块管理模块)
           key(区块高度)-value(区块头hash)              block-header-index
           key(区块头hash)-value(完整的区块头)           block-header
       交易:(放在交易管理模块)
</code></pre></div><ul><li>分叉链存储</li></ul> <div class="language- extra-class"><pre class="language-text"><code>     内存中缓存每一个分叉链的(起始高度、起始hash、结束高度、结束hash)，在硬盘中缓存全量分叉链数据
     不同链的分叉链集合存在不同的表，表名加chainID后缀，每一个分叉链对象如下:
         key(start区块高度+start区块hash)-value(完整的chains)          fork chains
     private Chain chain;
             private String id;
             private String preChainId;
             private BlockHeader startBlockHeader;
             private BlockHeader endBlockHeader;
             private List&lt;BlockHeader&gt; blockHeaderList;
             private List&lt;Block&gt; blockList;
</code></pre></div></li> <li><p>流程描述</p> <p>略</p></li> <li><p>依赖服务</p> <p>工具模块的数据库存储工具</p></li></ul> <h4 id="_2-3-2-区块同步"><a href="#_2-3-2-区块同步" aria-hidden="true" class="header-anchor">#</a> 2.3.2 区块同步</h4> <ul><li><p>功能说明:</p> <p>略</p></li> <li><p>流程描述</p> <ul><li>区块同步主流程</li></ul> <p><img src="/assets/img/block-synchronization.3b5f0ded.png" alt></p> <ul><li>获取网络上可用节点列表</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    1. 遍历节点，统计两个MAP，假定每个节点的(最新HASH+最新高度)是key
    2. 一个以key为主键统计次数
    3. 一个以key为主键记录持有该key的节点列表
    4. 最终统计出出现频率最大的key，就获取到当前可信的最新高度与最新hash，以及可信的节点列表
    
    举个栗子:
    现在同时连接到10个节点。其中4个节点(A,B,C,D)的最新区块高度是100，最新区块hash是aaa，其中6个节点(E,F,G,H,I,J)的最新区块高度是101，最新区块hash是bbb。
    最终返回(101，bbb,[E,F,G,H,I,J])。
</code></pre></div><ul><li>下载区块逻辑</li></ul> <p><img src="/assets/img/block-synchronization2.1bde323a.png" alt></p> <div class="language- extra-class"><pre class="language-text"><code>    在正式下载区块前，要判断本地与网络是否发生分叉，是否需要回滚。以便找到准确的区块下载高度。
    以下分情况讨论:
    取上一步的结果(101，bbb,[E,F,G,H,I,J])，同时LH(N)代表本地第N块的hash，RH(N)代表网络上第N块的hash。
    1.本地高度100&lt;网络高度101，LH(100)==RH(100)，正常，比远程节点落后，下载区块
    2.本地高度100&lt;网络高度101，LH(100)!=RH(100)，认为本地分叉，回滚本地区块，如果LH(99)==RH(99)
    回滚结束，从99块开始下载，如果LH(99)!=RH(99)，继续回滚，重复上述逻辑。但最多回滚10个块就停止，等待下次同步，这样可以避免被恶意节点攻击，大量回滚正常区块。
    3.本地高度102&gt;网络高度101，LH(101)==RH(101)，正常，比远程节点领先，无需下载区块
    4.本地高度102&gt;网络高度101，LH(101)!=RH(101)，认为本地分叉，先一次性回滚到高度与远程一致，重复场景2
    5.本地高度101=网络高度101，LH(101)==RH(101)，正常，与远程节点一致，无需下载区块
    6.本地高度101=网络高度101，LH(101)!=RH(101)，认为本地分叉，重复场景2
    
    场景1、2需要额外从节点下载与本地高度一致的区块，进行hash判断
    上述需要回滚的场景，要满足可用节点数(10个)&gt;配置，一致可用节点数(6个)占比超80%两个条件，避免节点太少导致频繁回滚。以上两个条件都不满足，清空已连接节点，重新获取可用节点。

    真正下载区块时，举个栗子:
    当前高度100，网络高度500，可用节点12个，一致可用节点10个，每个节点每次下载区块2个
    那么计算得出需要下载区块400个，400/(2*10)=20轮下载完毕，同时可以计算出每轮每个节点下载区块的高度范围
    伪代码表示
        For(20轮){
            for(10个节点){
                每个节点下载对应区块，并放到共享队列给区块验证线程处理
            }
        }
    考虑下载过程中，节点掉线的情况。可能20轮不能下载完，所以外层加循环。
        while(没有下载完){
            重新计算轮次、各节点下载区块高度区间
            For(20轮){
                for(10个节点){
                    每个节点下载对应区块，并放到共享队列给区块验证线程处理
                }
            }
        }
</code></pre></div><ul><li>从节点下载某高度区间内的区块</li></ul> <p><img src="/assets/img/block-synchronization3.99496017.png" alt></p></li> <li><p>依赖服务</p> <p>工具模块的数据库存储工具、RPC工具</p></li></ul> <h4 id="_2-3-3-区块基础验证"><a href="#_2-3-3-区块基础验证" aria-hidden="true" class="header-anchor">#</a> 2.3.3 区块基础验证</h4> <ul><li><p>功能说明:</p> <p>验证区块自身数据正确性,下载过程中验证，验证通过说明区块数据本身没有问题，验证失败则丢弃该区块</p></li> <li><p>流程描述</p> <ul><li>区块基本验证</li></ul> <p><img src="/assets/img/block-basic-validation.07557d70.png" alt></p> <ul><li>区块头验证</li></ul> <p><img src="/assets/img/block-basic-validation1.cf392d66.png" alt></p></li> <li><p>依赖服务</p> <p>工具模块的数据库存储工具</p></li></ul> <h4 id="_2-3-4-分叉块验证"><a href="#_2-3-4-分叉块验证" aria-hidden="true" class="header-anchor">#</a> 2.3.4 分叉块验证</h4> <ul><li><p>功能说明:</p> <p>验证区块上下文正确性，下载完成后验证，验证通过说明该区块与主链相连，验证失败说明该区块分叉，进入分叉链处理逻辑</p></li> <li><p>流程描述</p> <ul><li><p>定义一条主链(MasterChain)，一个分叉链集合(forkChains)</p></li> <li><p>定义待验证区块为Block</p></li> <li><p>定义主链高度MG，待验证区块高度BG</p></li> <li><p>定义主链最新区块HASH为MH，待验证区块HASH为BH，待验证区块PREHASH为BPH</p></li> <li><p>分六种情况讨论</p></li> <li><p>1.MG==BG，MH==BH，说明重复收到最新主链区块，丢弃</p></li> <li><p>2.MG==BG，MH!=BH，说明网络分叉</p> <ul><li>遍历已有分叉链集合，判断是否已存在此区块
<ul><li>如果已存在，丢弃该区块</li> <li>如果不存在，新建一条分叉链
<ul><li>判断是否能连接上其他的分叉链（若能连上，则连接到其他分叉链则视为一条链）</li> <li>递归判断</li></ul></li></ul></li></ul></li> <li><p>3.MG==BG-1，MH==BPH，说明区块连续，保存到主链</p></li> <li><p>4.MG==BG-1，MH!=BPH，说明网络分叉，处理同第2步</p></li> <li><p>5.MG&lt;BG-1，说明网络分叉，处理同第2步</p></li> <li><p>6.MG&gt;BG，说明网络分叉，处理同第2步</p></li></ul> <p>高度差1000以内缓存到磁盘，磁盘空间做大小限制，超出高度则丢弃，缓存空间满则按加入缓存时间顺序清理分叉链。
如果是正常运行时，收到其他节点转发的区块，发现分叉了要通知共识模块给生成这个区块的节点红牌惩罚，系统启动后的同步过程中不做这个判断</p> <p><img src="/assets/img/block-fork.a3b65fd6.png" alt></p></li> <li><p>依赖服务</p> <p>工具模块的数据库存储工具</p></li></ul> <h4 id="_2-3-5-分叉链管理"><a href="#_2-3-5-分叉链管理" aria-hidden="true" class="header-anchor">#</a> 2.3.5 分叉链管理</h4> <ul><li><p>功能说明:</p> <p>判断分叉链与主链是否需要进行切换</p></li> <li><p>流程描述
​</p> <ul><li>检查是否有分叉链能链接上主链，如果有则链接</li> <li>取出最长的一条分叉链与主链长度对比判断是否需要切换主链
<ul><li>如果分叉链长度比主链长度长3（配置）个区块以上则需要切换主链</li> <li>找到主链与最长分叉链的分叉点</li> <li>验证分叉链中的区块，如果验证通过继续往下执行</li> <li>回滚主链区块</li> <li>切换分叉链为主链</li></ul></li></ul></li></ul> <p><img src="/assets/img/block-fork-chain.ceeb7bdd.png" alt></p> <ul><li><p>依赖服务</p> <p>工具模块的数据库存储工具</p></li></ul> <h4 id="_2-3-5-孤儿链管理"><a href="#_2-3-5-孤儿链管理" aria-hidden="true" class="header-anchor">#</a> 2.3.5 孤儿链管理</h4> <h4 id="_2-3-6-转发区块"><a href="#_2-3-6-转发区块" aria-hidden="true" class="header-anchor">#</a> 2.3.6 转发区块</h4> <ul><li><p>功能说明:</p> <p>详细说明</p></li> <li><p>流程描述</p></li></ul> <ol><li>使用blockHash组装ForwardSmallBlockMessage，发送给目标节点</li> <li>目标节点收到ForwardSmallBlockMessage后，取出hash判断是否重复，如果不重复，使用hash组装GetSmallBlockMessage发给源节点</li> <li>源节点收到GetSmallBlockMessage后，取出hash，查询SmallBlock并组装SmallBlockMessage，发给目标节点</li> <li>后续交互流程参考广播区块</li></ol> <ul><li><p>依赖服务</p> <p>工具模块的数据库存储工具</p></li></ul> <h4 id="_2-3-7-广播区块"><a href="#_2-3-7-广播区块" aria-hidden="true" class="header-anchor">#</a> 2.3.7 广播区块</h4> <ul><li><p>功能说明:</p> <p>略</p></li> <li><p>流程描述</p></li></ul> <ol><li>根据HASH获取BlockHeader,TxList,组装成SmallBlock，</li> <li>将一个&lt;SmallBlock.hash,SmallBlock&gt;放入缓存中，若不主动删除，则在缓存存满或者存在时间超过1000秒时，自动清理</li> <li>组装SmallBlockMessage，调用RPC模块发送消息给目标节点</li> <li>目标节点收到消息后根据txHashList判断哪些交易本地没有,再组装GetTxGroupRequest发给源节点</li> <li>源节点收到信息后按照hashlist组装TxGroupMessage,返回给目标节点</li> <li>至此所有区块数据已经发送给目标节点。</li></ol> <ul><li><p>依赖服务</p> <p>工具模块的数据库存储工具</p></li></ul> <h4 id="_2-3-8-区块监控"><a href="#_2-3-8-区块监控" aria-hidden="true" class="header-anchor">#</a> 2.3.8 区块监控</h4> <ul><li><p>功能说明:</p> <p>略</p></li> <li><p>流程描述</p> <ul><li>启动监控定时任务，每分钟执行一次</li> <li>取本地最新区块头</li> <li>验证网络模块是否需要重启（如果本地最新区块3分钟都没有更新过则需要网络模块断开并随机重连），这里区分chainID</li></ul></li> <li><p>依赖服务</p> <p>工具模块的数据库存储工具</p></li></ul> <h2 id="三、事件说明"><a href="#三、事件说明" aria-hidden="true" class="header-anchor">#</a> 三、事件说明</h2> <h3 id="_3-1-发布的事件"><a href="#_3-1-发布的事件" aria-hidden="true" class="header-anchor">#</a> 3.1 发布的事件</h3> <h4 id="_3-1-1-同步完成"><a href="#_3-1-1-同步完成" aria-hidden="true" class="header-anchor">#</a> 3.1.1 同步完成</h4> <p>说明:同步完成，本地区块高度与网络高度一致时，发布该事件</p> <p>event_topic : &quot;bl_blockSyncComplete&quot;,</p> <div class="language- extra-class"><pre class="language-text"><code>data:{
    chainId
    height
    hash
}
</code></pre></div><h4 id="_3-1-2-保存区块"><a href="#_3-1-2-保存区块" aria-hidden="true" class="header-anchor">#</a> 3.1.2 保存区块</h4> <p>说明:每保存一个区块，发布该事件，初次同步时不发该事件</p> <p>event_topic : &quot;bl_saveBlock&quot;,</p> <div class="language- extra-class"><pre class="language-text"><code>data:{
    chainId
    height
    hash
}
</code></pre></div><h4 id="_3-1-3-回滚区块"><a href="#_3-1-3-回滚区块" aria-hidden="true" class="header-anchor">#</a> 3.1.3 回滚区块</h4> <p>说明:每回滚一个区块，发布该事件</p> <p>event_topic : &quot;bl_rollbackBlock&quot;,</p> <div class="language- extra-class"><pre class="language-text"><code>data:{
    chainId
    height
    hash
}
</code></pre></div><h3 id="_3-2-订阅的事件"><a href="#_3-2-订阅的事件" aria-hidden="true" class="header-anchor">#</a> 3.2 订阅的事件</h3> <h4 id="_3-2-1-网络稳定"><a href="#_3-2-1-网络稳定" aria-hidden="true" class="header-anchor">#</a> 3.2.1 网络稳定</h4> <p>说明:网络稳定时，发布该事件</p> <p>event_topic : &quot;nt_networkDone&quot;,</p> <pre><code>data:{
    chainId
}
</code></pre> <h2 id="四、协议"><a href="#四、协议" aria-hidden="true" class="header-anchor">#</a> 四、协议</h2> <h3 id="_4-1-网络通讯协议"><a href="#_4-1-网络通讯协议" aria-hidden="true" class="header-anchor">#</a> 4.1 网络通讯协议</h3> <pre><code>参见网络模块
</code></pre> <h3 id="_4-2-消息协议"><a href="#_4-2-消息协议" aria-hidden="true" class="header-anchor">#</a> 4.2 消息协议</h3> <h4 id="_4-2-1-单个摘要消息hashmessage"><a href="#_4-2-1-单个摘要消息hashmessage" aria-hidden="true" class="header-anchor">#</a> 4.2.1 单个摘要消息HashMessage</h4> <ul><li><p>消息说明:用于&quot;转发区块&quot;,&quot;孤儿链维护&quot;功能</p></li> <li><p>消息类型（cmd）</p> <p>forward,getBlock,getsBlock</p></li> <li><p>消息的格式（messageBody）</p></li></ul> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>chainID</td> <td>uint32</td> <td>链ID</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>hashLength</td> <td>VarInt</td> <td>数组长度</td></tr> <tr><td>?</td> <td>hash</td> <td>byte[]</td> <td>hash</td></tr></tbody></table> <ul><li><p>消息的验证</p> <p>略</p></li> <li><p>消息的处理逻辑</p></li></ul> <ol><li>目标节点收到消息后，先根据chainID判断缓存中hash是否重复</li> <li>如果重复，说明已经收到别的节点转发的SmallBlock，丢弃消息</li> <li>如果没有重复，用hash组装GetSmallBlockMessage，并发送给源节点</li></ol> <h4 id="_4-2-2-摘要列表消息hashlistmessage"><a href="#_4-2-2-摘要列表消息hashlistmessage" aria-hidden="true" class="header-anchor">#</a> 4.2.2 摘要列表消息HashListMessage</h4> <ul><li><p>消息说明:用于&quot;转发区块&quot;功能</p></li> <li><p>消息类型（cmd）</p> <p>GetSmallBlock</p></li> <li><p>消息的格式（messageBody）</p></li></ul> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>chainID</td> <td>uint32</td> <td>链ID</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>hashLength</td> <td>VarInt</td> <td>数组长度</td></tr> <tr><td>?</td> <td>blockHash</td> <td>byte[]</td> <td>hash</td></tr> <tr><td>?</td> <td>hashLength</td> <td>VarInt</td> <td>数组长度</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>hashLength</td> <td>VarInt</td> <td>数组长度</td></tr> <tr><td>?</td> <td>hash</td> <td>byte[]</td> <td>hash</td></tr></tbody></table> <ul><li><p>消息的验证</p> <p>略</p></li> <li><p>消息的处理逻辑</p></li></ul> <ol><li>根据chainID、hash获取SmallBlock对象</li> <li>组装SmallBlockMessage，并发送给源节点</li></ol> <h4 id="_4-2-3-区块广播消息smallblockmessage"><a href="#_4-2-3-区块广播消息smallblockmessage" aria-hidden="true" class="header-anchor">#</a> 4.2.3 区块广播消息SmallBlockMessage</h4> <ul><li><p>消息说明:用于&quot;转发区块&quot;、&quot;广播区块&quot;功能</p></li> <li><p>消息类型（short）</p> <p>SmallBlock</p></li> <li><p>消息的格式（messageBody）</p></li></ul> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>chainID</td> <td>uint32</td> <td>链ID</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>preHashLength</td> <td>VarInt</td> <td>preHash数组长度</td></tr> <tr><td>?</td> <td>preHash</td> <td>byte[]</td> <td>preHash</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>merkleHashLength</td> <td>VarInt</td> <td>merkleHash数组长度</td></tr> <tr><td>?</td> <td>merkleHash</td> <td>byte[]</td> <td>merkleHash</td></tr> <tr><td>48</td> <td>time</td> <td>Uint48</td> <td>时间</td></tr> <tr><td>32</td> <td>height</td> <td>Uint32</td> <td>区块高度</td></tr> <tr><td>32</td> <td>txCount</td> <td>Uint32</td> <td>交易数</td></tr> <tr><td>?</td> <td>extendLength</td> <td>VarInt</td> <td>extend数组长度</td></tr> <tr><td>?</td> <td>extend</td> <td>byte[]</td> <td>extend</td></tr> <tr><td>32</td> <td>publicKeyLength</td> <td>Uint32</td> <td>公钥数组长度</td></tr> <tr><td>?</td> <td>publicKey</td> <td>byte[]</td> <td>公钥</td></tr> <tr><td>1</td> <td>signAlgType</td> <td>byte</td> <td>签名算法类型</td></tr> <tr><td>?</td> <td>signBytesLength</td> <td>VarInt</td> <td>签名数组长度</td></tr> <tr><td>?</td> <td>signBytes</td> <td>byte[]</td> <td>签名</td></tr> <tr><td>?</td> <td>txHashListLength</td> <td>VarInt</td> <td>交易hash列表数组长度</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>txHashLength</td> <td>VarInt</td> <td>交易hash数组长度</td></tr> <tr><td>?</td> <td>txHash</td> <td>byte[]</td> <td>交易hash</td></tr></tbody></table> <ul><li><p>消息的验证</p> <p>略</p></li> <li><p>消息的处理逻辑</p></li></ul> <ol><li>判断区块时间戳是否大于(当前时间+10s)，如果大于这个时间，则判定为恶意提前出块，忽略该消息</li> <li>根据chainID、区块hash判断消息是否重复，如果重复，则忽略该消息(这里要求维护一个集合,按照chainID分类储存收到的区块hash)</li> <li>根据chainID、区块hash在DB中查询本地是否已经有该区块，如果已经有了，则忽略该消息</li> <li>验证区块头，验证失败，则忽略该消息</li> <li>取txHashList，判断那些tx本地没有，组装HashListMessage，发给源节点，获取没有的那些交易信息</li> <li>如果交易都有，组放入缓存队列，等待验证线程验证后存储</li></ol> <h4 id="_4-2-4-高度区间消息heightrangemessage"><a href="#_4-2-4-高度区间消息heightrangemessage" aria-hidden="true" class="header-anchor">#</a> 4.2.4 高度区间消息HeightRangeMessage</h4> <ul><li><p>消息说明:用于&quot;同步区块&quot;功能</p></li> <li><p>消息类型（cmd）</p> <p>GetBlocksByHeight</p></li> <li><p>消息的格式（messageBody）</p></li></ul> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>chainID</td> <td>uint32</td> <td>链ID</td></tr> <tr><td>32</td> <td>startHeight</td> <td>uint32</td> <td>起始高度</td></tr> <tr><td>32</td> <td>endHeight</td> <td>uint32</td> <td>结束高度</td></tr></tbody></table> <ul><li><p>消息的验证</p> <p>略</p></li> <li><p>消息的处理逻辑</p></li></ul> <ol><li>chainID、高度参数验证</li> <li>返回响应消息ReactMessage</li> <li>从endHeight开始查找Block,组装BlockMessage，发给目标节点</li> <li>查找到startHeight为止，组装CompleteMessage，发给目标节点</li></ol> <h4 id="_4-2-5-完整的区块消息blockmessage"><a href="#_4-2-5-完整的区块消息blockmessage" aria-hidden="true" class="header-anchor">#</a> 4.2.5 完整的区块消息BlockMessage</h4> <ul><li><p>消息说明:用于&quot;区块同步&quot;</p></li> <li><p>消息类型（cmd）</p> <p>Block</p></li> <li><p>消息的格式（messageBody）</p></li></ul> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>chainID</td> <td>uint32</td> <td>链ID</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>preHashLength</td> <td>VarInt</td> <td>preHash数组长度</td></tr> <tr><td>?</td> <td>preHash</td> <td>byte[]</td> <td>preHash</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>merkleHashLength</td> <td>VarInt</td> <td>merkleHash数组长度</td></tr> <tr><td>?</td> <td>merkleHash</td> <td>byte[]</td> <td>merkleHash</td></tr> <tr><td>48</td> <td>time</td> <td>Uint48</td> <td>时间</td></tr> <tr><td>32</td> <td>height</td> <td>Uint32</td> <td>区块高度</td></tr> <tr><td>32</td> <td>txCount</td> <td>Uint32</td> <td>交易数</td></tr> <tr><td>?</td> <td>extendLength</td> <td>VarInt</td> <td>extend数组长度</td></tr> <tr><td>?</td> <td>extend</td> <td>byte[]</td> <td>extend</td></tr> <tr><td>32</td> <td>publicKeyLength</td> <td>Uint32</td> <td>公钥数组长度</td></tr> <tr><td>?</td> <td>publicKey</td> <td>byte[]</td> <td>公钥</td></tr> <tr><td>1</td> <td>signAlgType</td> <td>byte</td> <td>签名算法类型</td></tr> <tr><td>?</td> <td>signBytesLength</td> <td>VarInt</td> <td>签名数组长度</td></tr> <tr><td>?</td> <td>signBytes</td> <td>byte[]</td> <td>区块签名</td></tr> <tr><td>16</td> <td>type</td> <td>uint16</td> <td>交易类型</td></tr> <tr><td>48</td> <td>time</td> <td>uint48</td> <td>交易时间</td></tr> <tr><td>?</td> <td>remarkLength</td> <td>VarInt</td> <td>备注数组长度</td></tr> <tr><td>?</td> <td>remark</td> <td>byte[]</td> <td>备注</td></tr> <tr><td>32</td> <td>fromCount</td> <td>Uint32</td> <td>转出记录数</td></tr> <tr><td>32</td> <td>fromAssetsChainId</td> <td>Uint32</td> <td>资产发行链的id</td></tr> <tr><td>32</td> <td>fromAssetsId</td> <td>Uint32</td> <td>资产id</td></tr> <tr><td>?</td> <td>fromAddress</td> <td>VarChar</td> <td>转出账户地址</td></tr> <tr><td>48</td> <td>amount</td> <td>Uint48</td> <td>转出金额</td></tr> <tr><td>32</td> <td>nonce</td> <td>Uint32</td> <td>交易顺序号，递增</td></tr> <tr><td>32</td> <td>toCount</td> <td>Uint32</td> <td>转入记录数</td></tr> <tr><td>32</td> <td>toAssetsChainId</td> <td>Uint32</td> <td>资产发行链的id</td></tr> <tr><td>32</td> <td>toAssetsId</td> <td>Uint32</td> <td>资产id</td></tr> <tr><td>?</td> <td>toAddress</td> <td>VarChar</td> <td>转入账户地址</td></tr> <tr><td>48</td> <td>amount</td> <td>Uint48</td> <td>转入金额</td></tr> <tr><td>32</td> <td>lockTIme</td> <td>Uint32</td> <td>锁定时间</td></tr> <tr><td>?</td> <td>txData</td> <td>T</td> <td>交易数据</td></tr> <tr><td>?</td> <td>txSignLength</td> <td>VarInt</td> <td>交易签名数组长度</td></tr> <tr><td>?</td> <td>txSign</td> <td>byte[]</td> <td>交易签名</td></tr></tbody></table> <ul><li><p>消息的验证</p> <p>略</p></li> <li><p>消息的处理逻辑</p></li></ul> <ol><li>放入缓存队列</li> <li>等待其他区块同步中</li></ol> <h4 id="_4-2-6-请求完成消息completemessage"><a href="#_4-2-6-请求完成消息completemessage" aria-hidden="true" class="header-anchor">#</a> 4.2.6 请求完成消息CompleteMessage</h4> <ul><li><p>消息说明:通用消息，用于异步请求，标志异步请求处理结束。</p></li> <li><p>消息类型（cmd）</p> <p>Complete</p></li> <li><p>消息的格式（messageBody）</p></li></ul> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>chainID</td> <td>uint32</td> <td>链ID</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>HashLength</td> <td>VarInt</td> <td>Hash数组长度</td></tr> <tr><td>?</td> <td>Hash</td> <td>byte[]</td> <td>Hash</td></tr> <tr><td>1</td> <td>success</td> <td>byte</td> <td>成功标志</td></tr></tbody></table> <ul><li><p>消息的验证</p> <p>略</p></li> <li><p>消息的处理逻辑</p></li></ul> <ol><li>根据chainID、hash查找源节点缓存的异步请求，把处理结果标志设置为完成。</li></ol> <h4 id="_4-2-7-交易列表的消息txgroupmessage"><a href="#_4-2-7-交易列表的消息txgroupmessage" aria-hidden="true" class="header-anchor">#</a> 4.2.7 交易列表的消息TxGroupMessage</h4> <ul><li><p>消息说明:用于&quot;转发区块&quot;</p></li> <li><p>消息类型（cmd）</p> <p>TxGroup</p></li> <li><p>消息的格式（messageBody）</p></li></ul> <table><thead><tr><th>Length</th> <th>Fields</th> <th>Type</th> <th>Remark</th></tr></thead> <tbody><tr><td>32</td> <td>chainID</td> <td>uint32</td> <td>链ID</td></tr> <tr><td>1</td> <td>digestAlgType</td> <td>byte</td> <td>摘要算法标识</td></tr> <tr><td>?</td> <td>requestHashLength</td> <td>VarInt</td> <td>requestHash数组长度</td></tr> <tr><td>?</td> <td>requestHash</td> <td>byte[]</td> <td>requestHash</td></tr> <tr><td>?</td> <td>txCount</td> <td>VarInt</td> <td>交易数</td></tr> <tr><td>16</td> <td>type</td> <td>uint16</td> <td>交易类型</td></tr> <tr><td>48</td> <td>time</td> <td>uint48</td> <td>交易时间</td></tr> <tr><td>?</td> <td>remarkLength</td> <td>VarInt</td> <td>备注数组长度</td></tr> <tr><td>?</td> <td>remark</td> <td>byte[]</td> <td>备注</td></tr> <tr><td>32</td> <td>fromCount</td> <td>Uint32</td> <td>转出记录数</td></tr> <tr><td>32</td> <td>fromAssetsChainId</td> <td>Uint32</td> <td>资产发行链的id</td></tr> <tr><td>32</td> <td>fromAssetsId</td> <td>Uint32</td> <td>资产id</td></tr> <tr><td>?</td> <td>fromAddress</td> <td>VarChar</td> <td>转出账户地址</td></tr> <tr><td>48</td> <td>amount</td> <td>Uint48</td> <td>转出金额</td></tr> <tr><td>32</td> <td>nonce</td> <td>Uint32</td> <td>交易顺序号，递增</td></tr> <tr><td>32</td> <td>toCount</td> <td>Uint32</td> <td>转入记录数</td></tr> <tr><td>32</td> <td>toAssetsChainId</td> <td>Uint32</td> <td>资产发行链的id</td></tr> <tr><td>32</td> <td>toAssetsId</td> <td>Uint32</td> <td>资产id</td></tr> <tr><td>?</td> <td>toAddress</td> <td>VarChar</td> <td>转入账户地址</td></tr> <tr><td>48</td> <td>amount</td> <td>Uint48</td> <td>转入金额</td></tr> <tr><td>32</td> <td>lockTIme</td> <td>Uint32</td> <td>锁定时间</td></tr> <tr><td>?</td> <td>txData</td> <td>T</td> <td>交易数据</td></tr> <tr><td>?</td> <td>txSignLength</td> <td>VarInt</td> <td>交易签名数组长度</td></tr> <tr><td>?</td> <td>txSign</td> <td>byte[]</td> <td>交易签名</td></tr></tbody></table> <ul><li><p>消息的验证</p> <p>略</p></li> <li><p>消息的处理逻辑</p> <p>略</p></li></ul> <h2 id="五、模块配置"><a href="#五、模块配置" aria-hidden="true" class="header-anchor">#</a> 五、模块配置</h2> <div class="language- extra-class"><pre class="language-text"><code>{
    {
        &quot;name&quot;: &quot;validBlockInterval&quot;,
        &quot;remark&quot;: &quot;为阻止恶意节点提前出块，设置此参数，区块时间戳大于当前时间多少就丢弃该区块&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;1000&quot;
    },
    {
        &quot;name&quot;: &quot;blockCache&quot;,
        &quot;remark&quot;: &quot;同步区块时最多缓存多少个区块&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;1000&quot;
    },
    {
        &quot;name&quot;: &quot;smallBlockCache&quot;,
        &quot;remark&quot;: &quot;系统正常运行时最多缓存多少个从别的节点接收到的小区块&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;100&quot;
    },
    {
        &quot;name&quot;: &quot;chainSwtichThreshold&quot;,
        &quot;remark&quot;: &quot;分叉链切换为主链的高度差阈值&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;1&quot;
    },
    {
        &quot;name&quot;: &quot;chainName&quot;,
        &quot;remark&quot;: &quot;链名称&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;nuls&quot;
    },
    {
        &quot;name&quot;: &quot;serverIp&quot;,
        &quot;remark&quot;: &quot;服务ip&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;127.0.0.1&quot;
    },
    {
        &quot;name&quot;: &quot;serverPort&quot;,
        &quot;remark&quot;: &quot;服务端口&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;&quot;
    },
    {
        &quot;name&quot;: &quot;blockMaxSize&quot;,
        &quot;remark&quot;: &quot;区块大小最大值&quot;,
        &quot;readOnly&quot;: &quot;false&quot;,
        &quot;value&quot;: &quot;3145728&quot;
    },
    {
        &quot;name&quot;: &quot;resetTime&quot;,
        &quot;remark&quot;: &quot;持续多长时间区块高度没有更新时，就重新获取可用节点&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;180&quot;
    },
    {
        &quot;name&quot;: &quot;cacheSize&quot;,
        &quot;remark&quot;: &quot;分叉链、孤儿链缓存区块最大数量&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;10000&quot;
    },
    {
        &quot;name&quot;: &quot;heightRange&quot;,
        &quot;remark&quot;: &quot;缓存到分叉链的高度区间&quot;,
        &quot;readOnly&quot;: &quot;false&quot;,
        &quot;value&quot;: &quot;1000&quot;
    },
    {
        &quot;name&quot;: &quot;maxRollback&quot;,
        &quot;remark&quot;: &quot;每次最多回滚多少区块&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;20&quot;
    },
    {
        &quot;name&quot;: &quot;consistencyNodePercent&quot;,
        &quot;remark&quot;: &quot;一致可用节点最低比例，低于此数不同步区块&quot;,
        &quot;readOnly&quot;: &quot;false&quot;,
        &quot;value&quot;: &quot;80&quot;
    },
    {
        &quot;name&quot;: &quot;minNodeAmount&quot;,
        &quot;remark&quot;: &quot;最小可用节点个数，低于此数不同步区块&quot;,
        &quot;readOnly&quot;: &quot;false&quot;,
        &quot;value&quot;: &quot;1&quot;
    },
    {
        &quot;name&quot;: &quot;downloadNumber&quot;,
        &quot;remark&quot;: &quot;同步时，每次从一个节点下载多少区块&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;20&quot;
    },
    {
        &quot;name&quot;: &quot;orphanChainMaxAge&quot;,
        &quot;remark&quot;: &quot;孤儿链最大年龄&quot;,
        &quot;readOnly&quot;: &quot;true&quot;,
        &quot;value&quot;: &quot;10&quot;
    },
    {
        &quot;name&quot;: &quot;extendMaxSize&quot;,
        &quot;remark&quot;: &quot;区块头扩展字段最大值&quot;,
        &quot;readOnly&quot;: &quot;false&quot;,
        &quot;value&quot;: &quot;1024&quot;
    }
}

</code></pre></div><h2 id="六、java特有的设计"><a href="#六、java特有的设计" aria-hidden="true" class="header-anchor">#</a> 六、Java特有的设计</h2> <ul><li>Block对象设计</li></ul> <blockquote><table><thead><tr><th><code>字段名称</code></th> <th><code>字段类型</code></th> <th><code>说明</code></th></tr></thead> <tbody><tr><td>blockHeader</td> <td>BlockHeader</td> <td>区块头</td></tr> <tr><td>transactions</td> <td>List<Transaction></Transaction></td> <td>交易列表</td></tr></tbody></table></blockquote> <ul><li>SmallBlock对象设计</li></ul> <blockquote><table><thead><tr><th><code>字段名称</code></th> <th><code>字段类型</code></th> <th><code>说明</code></th></tr></thead> <tbody><tr><td>blockHeader</td> <td>BlockHeader</td> <td>区块头</td></tr> <tr><td>transactions</td> <td>List<String></String></td> <td>所有交易HASH列表</td></tr> <tr><td>subTxList</td> <td>List<Transaction></Transaction></td> <td>其他节点一定没有的交易(如共识奖励交易、红黄牌交易等)</td></tr></tbody></table></blockquote> <ul><li>BlockHeader对象设计</li></ul> <blockquote><table><thead><tr><th><code>字段名称</code></th> <th><code>字段类型</code></th> <th><code>说明</code></th></tr></thead> <tbody><tr><td>hash</td> <td>String</td> <td>区块HASH</td></tr> <tr><td>preHash</td> <td>String</td> <td>上一区块HASH</td></tr> <tr><td>merkleHash</td> <td>String</td> <td>区块MerkleHash</td></tr> <tr><td>height</td> <td>int</td> <td>区块高度</td></tr> <tr><td>time</td> <td>long</td> <td>区块打包时间</td></tr> <tr><td>txCount</td> <td>short</td> <td>交易数</td></tr> <tr><td>packingAddress</td> <td>String</td> <td>打包地址</td></tr> <tr><td>extend</td> <td>byte[]</td> <td>扩展字段</td></tr> <tr><td>blockSignature</td> <td>BlockSignature</td> <td>区块签名</td></tr></tbody></table></blockquote> <ul><li>BlockSignature对象设计</li></ul> <blockquote><table><thead><tr><th><code>字段名称</code></th> <th><code>字段类型</code></th> <th><code>说明</code></th></tr></thead> <tbody><tr><td>signData</td> <td>String</td> <td>区块签名</td></tr> <tr><td>publicKey</td> <td>byte[]</td> <td>公钥</td></tr></tbody></table></blockquote> <h2 id="七、补充内容"><a href="#七、补充内容" aria-hidden="true" class="header-anchor">#</a> 七、补充内容</h2></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/nuls-io/devsite/edit/dev/docs/zh/NULSInfrastructure/blockModuleDesign.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2019-1-10 20:03:04</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.0877bdcb.js" defer></script><script src="/assets/js/25.0460bbcd.js" defer></script>
  </body>
</html>
